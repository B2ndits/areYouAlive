import { preferences } from '@kit.ArkData';
import { promptAction } from '@kit.ArkUI';
import router from '@ohos.router';
import { DataMasking } from '../utils/DataMasking';
import { LocationService, LocationInfo } from '../services/LocationService';
import { SmsService } from '../services/SmsService';

@Entry
@Component
struct Index {
  @State userName:string =""
  @State Phone:string = ""
  @State isSignIn:boolean = false
  @State Time:string = ""
  @State newTime:string = ""
  @State isEditingName: boolean = false
  @State isEditingPhone: boolean = false
  @State lastSignInLocation: LocationInfo | null = null
  @State lastSignInTimestamp: number = 0

  async aboutToAppear() {
    try {
      const storage = await preferences.getPreferences(getContext(), 'user_data');
      const saveName = await storage.get('userName', '') as string;
      const savePhone = await storage.get('Phone', '') as string;
      const saveSign = await storage.get('isSignIn', false) as boolean;
      const saveTime = await storage.get('Time', '') as string;
      const saveLocation = await storage.get('lastSignInLocation', '') as string;
      const saveTimestamp = await storage.get('lastSignInTimestamp', 0) as number;

      AppStorage.setOrCreate("userName", saveName);
      AppStorage.setOrCreate("Phone", savePhone);
      AppStorage.setOrCreate("isSignIn", saveSign);
      this.userName = saveName;
      this.Phone = savePhone;
      this.isSignIn = saveSign;
      this.Time = saveTime;
      this.lastSignInTimestamp = saveTimestamp;

      // è§£æä¿å­˜çš„ä½ç½®ä¿¡æ¯
      if (saveLocation) {
        try {
          this.lastSignInLocation = JSON.parse(saveLocation) as LocationInfo;
        } catch (e) {
          console.error('è§£æä½ç½®ä¿¡æ¯å¤±è´¥:', JSON.stringify(e));
        }
      }

      // æ£€æŸ¥æ˜¯å¦è¶…è¿‡48å°æ—¶æœªç­¾åˆ°
      this.checkAndSendEmergencySms();

      setInterval(() => {
        this.newTime = new Date().toLocaleString();
      }, 1000);
    } catch (err) {
      console.error('åå¥½è®¾ç½®åŠ è½½å¤±è´¥:', JSON.stringify(err));
    }
  }

  async saveToLocal() {
    try {
      AppStorage.setOrCreate("userName",this.userName)
      AppStorage.setOrCreate("Phone",this.Phone)
      AppStorage.setOrCreate("isSignIn",this.isSignIn)
      AppStorage.setOrCreate("Time",this.Time)

      const storage = await preferences.getPreferences(getContext(), 'user_data');
      await storage.put('userName', this.userName);
      await storage.put('Phone', this.Phone);
      await storage.put('isSignIn', this.isSignIn);
      await storage.put('Time', this.Time);

      // ä¿å­˜ä½ç½®ä¿¡æ¯
      if (this.lastSignInLocation) {
        await storage.put('lastSignInLocation', JSON.stringify(this.lastSignInLocation));
      }
      await storage.put('lastSignInTimestamp', this.lastSignInTimestamp);

      await storage.flush();
    } catch (err) {
      console.error('åå¥½è®¾ç½®ä¿å­˜å¤±è´¥:', JSON.stringify(err));
    }
  }

  /**
   * æ£€æŸ¥æ˜¯å¦è¶…è¿‡48å°æ—¶æœªç­¾åˆ°ï¼Œå¦‚æœæ˜¯åˆ™å‘é€æ±‚æ•‘çŸ­ä¿¡
   */
  async checkAndSendEmergencySms() {
    // æ£€æŸ¥æ˜¯å¦æœ‰å¿…è¦çš„ç­¾åˆ°ä¿¡æ¯
    if (!this.isSignIn || this.lastSignInTimestamp === 0 || !this.lastSignInLocation) {
      return;
    }

    // è®¡ç®—è·ç¦»ä¸Šæ¬¡ç­¾åˆ°çš„æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    const currentTime = Date.now();
    const timeSinceLastSignIn = currentTime - this.lastSignInTimestamp;

    // 48å°æ—¶ = 48 * 60 * 60 * 1000 = 172800000 æ¯«ç§’
    const fortyEightHours = 48 * 60 * 60 * 1000;

    // å¦‚æœè¶…è¿‡48å°æ—¶ï¼Œå‘é€çŸ­ä¿¡
    if (timeSinceLastSignIn > fortyEightHours) {
      const locationStr = LocationService.formatLocation(this.lastSignInLocation);
      await SmsService.sendEmergencySms(
        this.Phone,
        this.userName,
        this.Time,
        locationStr
      );
      console.info('å·²å‘é€48å°æ—¶æœªç­¾åˆ°æ±‚æ•‘çŸ­ä¿¡');
    }
  }

  build() {
    Column() {
      Column(){
        if (this.isEditingName) {
          TextInput({text: this.userName, placeholder: "å§“å"})
            .width("80%")
            .height(40)
            .textAlign(TextAlign.Center)
            .fontColor(Color.Black)
            .fontWeight(FontWeight.Regular)
            .backgroundColor(Color.Transparent)
            .fontSize(16)
            .onChange((value) => {
              this.userName = value
            })
            .onBlur(() => {
              this.isEditingName = false;
              this.saveToLocal()
            })
        } else {
          Text(this.userName ? DataMasking.maskName(this.userName) : "å§“å")
            .width("80%")
            .height(40)
            .textAlign(TextAlign.Center)
            .fontColor(this.userName ? Color.Black : "#aaaaaa")
            .fontWeight(FontWeight.Regular)
            .fontSize(16)
            .onClick(() => {
              this.isEditingName = true;
            })
        }

        if (this.isEditingPhone) {
          TextInput({text: this.Phone, placeholder: "ç´§æ€¥è”ç³»äºº"})
            .width("80%")
            .height(40)
            .textAlign(TextAlign.Center)
            .fontColor(Color.Black)
            .fontWeight(FontWeight.Regular)
            .backgroundColor(Color.Transparent)
            .fontSize(16)
            .type(InputType.PhoneNumber)
            .onChange((value) => {
              this.Phone = value
            })
            .onBlur(() => {
              this.isEditingPhone = false;
              this.saveToLocal()
            })
        } else {
          Text(this.Phone ? DataMasking.maskPhone(this.Phone) : "ç´§æ€¥è”ç³»äºº")
            .width("80%")
            .height(40)
            .textAlign(TextAlign.Center)
            .fontColor(this.Phone ? Color.Black : "#aaaaaa")
            .fontWeight(FontWeight.Regular)
            .fontSize(16)
            .onClick(() => {
              this.isEditingPhone = true;
            })
        }
      }
      .width("100%")
      .height("20%")
      .justifyContent(FlexAlign.Center)
      .margin({top:"10%"})

      Button(){
        Column() {
          if (this.isSignIn){
            Text("å¤ªæ£’äº†~åˆæ´»äº†ä¸€å¤©ğŸ‘")
              .fontSize(20)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
            Text("æ‰“å¡æ—¶é—´:"+this.Time)
              .fontSize(12)
              .fontColor(Color.White)
              .margin({top: 8})
          } else {
            Text("æ´»ç€ä¹ˆ")
              .fontSize(20)
              .fontColor(Color.White)
              .fontWeight(FontWeight.Bold)
            Text("å½“å‰æ—¶é—´:"+this.newTime)
              .fontSize(12)
              .fontColor(Color.White)
              .margin({top: 8})
          }
        }
      }
        .borderRadius("100%")
        .backgroundColor(this.isSignIn?"#CCCCCC":"#4CAF50")
        .width("220vp")
        .height("220vp")
        .margin({top:"5%"})
        .onClick(async ()=>{
          if (this.userName == "" || this.Phone == "") {
            try {
              promptAction.showToast({ message: "è¯·å…ˆå¡«å†™å§“åå’Œç´§æ€¥è”ç³»äºº" })
            } catch (error) {
              console.error('ç­¾åˆ°å¼¹çª—é”™è¯¯:', JSON.stringify(error));
            }
            return;
          }
          if (!this.isSignIn) {
            // è¯·æ±‚ä½ç½®æƒé™
            await LocationService.requestLocationPermission(getContext());

            // è·å–å½“å‰ä½ç½®
            const location = await LocationService.getCurrentLocation();
            if (location) {
              this.lastSignInLocation = location;
            } else {
              try {
                promptAction.showToast({ message: "è·å–ä½ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä½ç½®æƒé™" })
              } catch (error) {
                console.error('ä½ç½®æç¤ºé”™è¯¯:', JSON.stringify(error));
              }
            }

            // æ›´æ–°ç­¾åˆ°æ—¶é—´å’Œæ—¶é—´æˆ³
            this.Time = new Date().toLocaleString();
            this.lastSignInTimestamp = Date.now();
            this.saveToLocal()
          }
          this.isSignIn = true
        })



      Column({space:10}){
        Text("48å°æ—¶æœªç­¾åˆ°ï¼Œç³»ç»Ÿå°†ä¼šä»¥ä½ çš„åä¹‰é€šè¿‡çŸ­ä¿¡é€šçŸ¥ä½ çš„ç´§æ€¥è”ç³»äººï¼")
          .fontSize(12)
          .fontColor("#aaaaaa")
          .width(240)
          .textAlign(TextAlign.Center)

        Row({space: 4}) {
          Text("ç‚¹å‡»ç­¾åˆ°å³åŒæ„")
            .fontSize(12)
            .fontColor("#aaaaaa")

          Text("éšç§æ”¿ç­–")
            .fontSize(12)
            .fontColor('#4CAF50')
            .decoration({ type: TextDecorationType.Underline })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/PrivacyPolicy'
              }).catch((err: Error) => {
                console.error('è·³è½¬éšç§æ”¿ç­–é¡µé¢å¤±è´¥:', JSON.stringify(err));
              })
            })

          Text("å’Œ")
            .fontSize(12)
            .fontColor("#aaaaaa")

          Text("ç”¨æˆ·åè®®")
            .fontSize(12)
            .fontColor('#4CAF50')
            .decoration({ type: TextDecorationType.Underline })
            .onClick(() => {
              router.pushUrl({
                url: 'pages/UserAgreement'
              }).catch((err: Error) => {
                console.error('è·³è½¬ç”¨æˆ·åè®®é¡µé¢å¤±è´¥:', JSON.stringify(err));
              })
            })
        }
      }
      .layoutWeight(1)
      .width("100%")
      .justifyContent(FlexAlign.End)
      .margin({bottom:10})
    }
    .height('100%')
    .width('100%')
  }
}